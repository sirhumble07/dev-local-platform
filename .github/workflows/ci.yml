# CI pipeline for Pull Requests
# Runs: lint -> tests -> build image -> validate compose
# Jobs are split so failures are clear and fast feedback is provided.

name: CI
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read

jobs:
  lint:
    name: Lint (Python + Dockerfile)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install ruff (fast linter)
        run: python -m pip install --upgrade pip && pip install ruff==0.5.11

      - name: Run ruff
        run: ruff check app

      - name: Lint Dockerfile with hadolint
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: app/Dockerfile

  test:
    name: Test (pytest)
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 20
    strategy:
      matrix:
        python-version: ['3.11'] # ensure CI runs on 3.11 to avoid httpx/httpcore incompatibilities
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: python -m pip install --upgrade pip && pip install -r app/requirements.txt

      - name: Run tests
        run: python -m pytest -q

      - name: Upload test results (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results
          path: ./

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build image (no push)
        id: build
        uses: docker/build-push-action@v4
        with:
          context: ./app
          file: ./app/Dockerfile
          push: false
          tags: devops-local-app:pr-${{ github.run_id }}
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at }}

      - name: Save image tar artifact
        run: |
          IMAGE=devops-local-app:pr-${{ github.run_id }}
          docker save "$IMAGE" -o image.tar
      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-image
          path: image.tar

  security:
    name: Security Scan (SBOM + Trivy)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download built image artifact
        uses: actions/download-artifact@v4
        with:
          name: built-image
          path: ./artifacts

      - name: Load image into Docker
        run: |
          IMAGE=devops-local-app:pr-${{ github.run_id }}
          docker load -i artifacts/image.tar
          docker images | grep devops-local-app || true

      - name: Generate SBOM (syft) and upload
        uses: anchore/syft-action@v0.11.2
        with:
          image: devops-local-app:pr-${{ github.run_id }}
          output_format: json
          output_file: sbom.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

      - name: Install Trivy CLI
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Scan image with Trivy (fail on HIGH/CRITICAL)
        run: |
          trivy image --severity HIGH,CRITICAL --exit-code 1 --format json -o trivy.json devops-local-app:pr-${{ github.run_id }}

      - name: Upload Trivy report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy.json


  compose-validate:
    name: Validate docker-compose
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose config
        # This ensures the docker-compose file is syntactically valid. It does not run containers.
        run: |
          docker compose -f docker-compose.yml config

      - name: Lint docker-compose (yamllint)
        run: |
          python -m pip install --upgrade pip && pip install yamllint
          yamllint -c '{extends: default, rules: {line-length: {max: 140}}}' docker-compose.yml

# Notes / Explanations:
# - Lint job ensures code style and Dockerfile best-practices are enforced early.
# - Test job runs unit/integration tests on Python 3.11 to avoid httpx/httpcore issues on newer Python versions.
# - Build job builds the Docker image but does not push it (build once, deploy many pattern). The built image is saved as an artifact.
# - Compose-validate checks `docker-compose.yml` is structurally valid. It could be extended to run `docker compose up --build --abort-on-container-exit` in a job that has longer timeout to simulate full integration tests.
